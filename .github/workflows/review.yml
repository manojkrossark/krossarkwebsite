name: Google Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  gemini_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get changed files diff
        id: get_diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git fetch origin ${{ github.event.pull_request.head.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }} origin/${{ github.event.pull_request.head.ref }} > changes.diff

          if [ ! -s changes.diff ]; then
            echo "No changes detected."
            echo "review=No diff content to review." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Encode diff as JSON-safe string
          DIFF=$(head -c 65536 changes.diff | jq -Rs .)
          echo "diff=$DIFF" >> $GITHUB_OUTPUT

      - name: Call Google Gemini API for review
        id: gemini
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          echo "Requesting Google Gemini code review..."

          DIFF_CONTENT=${{ steps.get_diff.outputs.diff }}
          PROMPT="You are a helpful code reviewer. Please review the following git diff and provide feedback on potential issues and improvements:\n\n${DIFF_CONTENT}\n"

          MODEL="gemini-1.5-flash"
          ENDPOINT="https://generativelanguage.googleapis.com/v1beta1/models/${MODEL}:generateContent"

          PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT" \
            '{
              contents: [
                {
                  role: "user",
                  parts: [
                    {
                      text: $prompt
                    }
                  ]
                }
              ]
            }')

          RESPONSE=$(curl -s -X POST "$ENDPOINT?key=$GOOGLE_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Gemini response received."

          REVIEW=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [ -z "$REVIEW" ]; then
            echo "No review found in the Gemini response."
            REVIEW="‚ö†Ô∏è No review generated or unexpected response format."
          fi

          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Gemini AI Review as PR Comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.PAT }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ü§ñ Google Gemini AI Code Review
            ${{ steps.gemini.outputs.review }}
