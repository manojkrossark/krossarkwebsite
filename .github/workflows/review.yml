name: Google Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  gemini_review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get changed files diff
      id: diff
      run: |
        git fetch origin ${{ github.event.pull_request.base.ref }}
        git diff origin/${{ github.event.pull_request.base.ref }} -- ${{ github.event.pull_request.head.ref }} > changes.diff
        DIFF=$(head -c 65536 changes.diff | jq -Rs .)
        echo "diff=$DIFF" >> $GITHUB_OUTPUT

    - name: Call Google Gemini API for review
      id: gemini
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "Requesting Google Gemini code review..."

        PROMPT="You are a helpful code reviewer. Please review the following git diff and provide feedback on potential issues and improvements:\n\n$DIFF_CONTENT\n\n"

        MODEL="gemini-1.5-flash"
        ENDPOINT="https://generativelanguage.googleapis.com/v1beta2/models/${MODEL}:generateText"

        PAYLOAD=$(jq -n \
          --arg prompt "$PROMPT" \
          '{
            prompt: {
              text: $prompt
            },
            temperature: 0.2,
            candidateCount: 1,
            topP: 0.95,
            topK: 40
          }')

        echo "Payload sent:"
        echo "$PAYLOAD"

        RESPONSE=$(curl -w "\nHTTP_STATUS:%{http_code}\n" -s -X POST "$ENDPOINT?key=$GOOGLE_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD")

        HTTP_STATUS=$(echo "$RESPONSE" | tr '\n' ' ' | sed -E 's/.*HTTP_STATUS:([0-9]+).*/\1/')
        BODY=$(echo "$RESPONSE" | sed -E 's/HTTP_STATUS:[0-9]+//g')

        echo "HTTP status: $HTTP_STATUS"
        echo "Response body: $BODY"

        if [ "$HTTP_STATUS" != "200" ]; then
          echo "Error response from Google Gemini API"
          echo "review=Error: HTTP status $HTTP_STATUS from API" >> $GITHUB_OUTPUT
          exit 1
        fi

        REVIEW=$(echo "$BODY" | jq -r '.candidates[0].output // empty')

        if [ -z "$REVIEW" ]; then
          echo "No review text found in Gemini response."
          REVIEW="No review generated or unexpected response format."
        fi

        echo "Parsed review:"
        echo "$REVIEW"

        echo "review=$REVIEW" >> $GITHUB_OUTPUT

    - name: Post review comment on PR
      uses: peter-evans/create-or-update-comment@v2
      with:
        token: ${{ secrets.PAT }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ### ðŸ¤– Google Gemini AI Code Review
          ${{ steps.gemini.outputs.review }}
